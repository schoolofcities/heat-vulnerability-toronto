<script>
	import { onMount } from 'svelte';
	import { showHospitals, showCooling, showPool, showAptNoAir } from '../routes/stores.js';
	import maplibregl from 'maplibre-gl';
	import * as pmtiles from 'pmtiles';
	import Wards from "../data/wards.geo.json";
	import Vulnerdata from "../data/data-reduced-final.geo.json";
	import Cooling from "../data/indoor-cooling-centres.geo.json";
	import Pool from "../data/swimming-wading-pools.geo.json";
	import AptNoAir from "../data/apt-no-aircon.geo.json";
	import Hospitals from "../data/hospitals.geo.json";
	import SubwayLines from "../data/subwayLines.geo.json";
	import SubwayStns from "../data/subwayStations.geo.json";
	import BaseLayer from "../data/toronto.json";


	let map;
	let PMTILES_URL = "/heat-vulnerability-toronto/toronto.pmtiles";

	export let index;

	let protocol = new pmtiles.Protocol();
	maplibregl.addProtocol('pmtiles', protocol.tile);

	let pageHeight;
	let pageWidth;

	let mapHeight = 665;
	$: if (pageHeight < 800) {
		mapHeight = pageHeight - 200;
	} else {
		mapHeight = 665
	}

	let mapWidth = pageWidth;

	const indexs = {
		"vulnerability": {
			"column": "pca_vuln_index",
			"name": "Heat Vulnerability Index",
			"breaks": [-6,-1,0,1,3],
			"colours": ["#ffffff","#f1c500","#e6851a","#dc4633"]
		}, 
		"heatdegree": {
			"column": "degree20_sum_temp",
			"name": "Extreme Heat Degree Days",
			"breaks": [2.3, 12.5, 13.9, 14.7, 15.4],
			"colours": ["#fff9dd","#f1c500","#ea9b11","#e37122","#dc4633"]
		},
		"adaptive": {
			"column": "pca_adaptive_index",
			"name": "Adaptive Capacity Index",
			"breaks": [0, 0.64, 0.7, 0.74, 0.78],
			"colours": ["#2f57db", "#5947ac", "#883477", "#bb203e", "#e41010"]
		},
		"sensitivity": {
			"column": "pca_sensitivity_index",
			"name": "Sensitivity Index",
			"breaks": [0, 0.46, 0.52, 0.56, 0.61],
			"colours": ["#2f57db", "#5947ac", "#883477", "#bb203e", "#e41010"]
		},
	};

	// Adding scale bar to the map
	let scale = new maplibregl.ScaleControl({
		maxWidth: 100,
		unit: 'metric',
	});


	// Function to toggle the visibility of Hospitals layer
	function toggleHospitals() {
		showHospitals.update((value) => !value);
		updateLayerVisibility('hospitals', $showHospitals);
	}

	// Function to toggle the visibility of Cooling Centres layer
	function toggleCooling() {
		showCooling.update((value) => !value);
		updateLayerVisibility('cooling-cnts', $showCooling);
	}

	// Function to toggle the visibility of Swimming/Wading Pools layer
	function togglePool() {
		showPool.update((value) => !value);
		updateLayerVisibility('pool-locs', $showPool);
	}

	// Function to toggle the visibility of Apartments without Air Condition layer
	function toggleAptNoAir() {
		showAptNoAir.update((value) => !value);
		updateLayerVisibility('AptNoAir', $showAptNoAir);
	}

	function updateLayerVisibility(layerID, visibility) {
		if (map) {
		map.setPaintProperty(layerID, 'circle-opacity', visibility ? 1 : 0);
		map.setPaintProperty(layerID, 'circle-stroke-opacity', visibility ? 1 : 0);
		}
	}

	$: updateLayerVisibility('hospitals', $showHospitals);
	$: updateLayerVisibility('cooling-cnts', $showCooling);
	$: updateLayerVisibility('pool-locs', $showPool);
	$: updateLayerVisibility('AptNoAir', $showAptNoAir);
  
	const maxBounds = [
		[-79.771200, 43.440000], // SW coords
		[-78.914763, 43.930740] // NE coords
	];

	onMount(() => {
		map = new maplibregl.Map({
			container: index, 
			style: {
					"version": 8,
					"name": "Empty",
					"glyphs": "https://schoolofcities.github.io/fonts/fonts/{fontstack}/{range}.pbf",
					"sources": {},
					"layers": [
						{
							"id": "background",
							"type": "background",
							"paint": {
								"background-color": "rgba(0,0,0,0)"
							}
						}
					]
				},
			center: [-79.37, 43.715],
			zoom: 10.5,
			maxZoom: 13,
			minZoom: 10,
			bearing: -17.1,
			projection: 'globe',
			scrollZoom: true,
			maxBounds: maxBounds,
			attributionControl: true
		});

		map.addControl(scale, 'bottom-left');
		// Adding zoom and rotation controls to the map
		map.addControl(new maplibregl.NavigationControl(), 'top-left');
		map.scrollZoom.disable();

		let protoLayers = BaseLayer;

		map.on('load', function() {
			const attributions = [
				'Â© <a href="https://openstreetmap.org">OpenStreetMap</a>',
				'<a href="https://github.com/Moraine729/Toronto_Heat_Vulnerability">Github</a>',
				'<a href="https://open.toronto.ca/">City of Toronto Open Data Portal</a>'
			];

			// Convert the array into a single string
			const attributionString = attributions.join(' | ');

			// Add the source with the concatenated attribution string
			map.addSource('protomaps', {
				type: "vector",
				url: "pmtiles://" + PMTILES_URL,
				attribution: attributionString,
				attributionControl: false,
			});

			protoLayers.forEach(e => {
				map.addLayer(e);
			});

			// Disable pitch control
			map.touchZoomRotate.disableRotation();
			
			

			map.addSource('Wards', {
				'type': 'geojson',
				'data': Wards
			});

			map.addSource('Vulnerdata', {
				'type': 'geojson',
				'data': Vulnerdata
			});

			map.addSource('SubwayLines', {
				'type': 'geojson',
				'data': SubwayLines
			});
			map.addSource('SubwayStns', {
				'type': 'geojson',
				'data': SubwayStns
			});

			map.addSource('Hospitals', {
				'type': 'geojson',
				'data': Hospitals
			});

			map.addSource('Cooling', {
				'type': 'geojson',
				'data': Cooling
			});

			map.addSource('Pool', {
				'type': 'geojson',
				'data': Pool
			});

			map.addSource('AptNoAir', {
				'type': 'geojson',
				'data': AptNoAir
			});

			

			

			map.addLayer({
				'id': 'Vulnerdata',
				'type': 'fill',
				'source': 'Vulnerdata',
				'layout': {},
				'paint': {
					'fill-color': [
						'interpolate',
						['linear'],
						['get', indexs[index].column],
							indexs[index].breaks[0],
							indexs[index].colours[0],
							indexs[index].breaks[1],
							indexs[index].colours[1],
							indexs[index].breaks[2],
							indexs[index].colours[2],
							indexs[index].breaks[3],
							indexs[index].colours[3]
					],
					'fill-opacity': 0.7,
					}
				});

			map.addLayer({
				id: 'subway-lines',
				type: 'line',
				source: 'SubwayLines',
				paint: {
					'line-color': '#1E3765',
					'line-width': 1,
					},
			});

			map.addLayer({
				id: 'subway-stations',
				type: 'circle',
				source: 'SubwayStns',
				paint: {
					'circle-color': '#1E3765',
					'circle-radius': 3,
					// 'circle-stroke-color': '#ffffff',
					// 'circle-stroke-width': 1.2,
				},
			});

			map.addLayer({
				'id': 'WardsWhite',
				'type': 'line',
				'source': 'Wards',
				'layout': {},
				'paint': {
					'line-color': '#fff',
					'line-width': 4,
					'line-opacity': 0.4
				}
			}, 'subway-lines');

			map.addLayer({
				'id': 'WardsBlack',
				'type': 'line',
				'source': 'Wards',
				'layout': {},
				'paint': {
					'line-color': '#4d4d4d',
					'line-width': 1,
					'line-opacity': 1
				}
			}, 'subway-lines');

			map.addLayer({
				id: 'AptNoAir',
				type: 'circle',
				source: 'AptNoAir',
				paint: {
					'circle-color': 'black',
					'circle-radius': 2,
					// 'circle-stroke-color': '#6D247A',
					// 'circle-stroke-width': 0,
				},
			});

			map.addLayer({
				id: 'cooling-cnts',
				type: 'circle',
				source: 'Cooling',
				paint: {
					'circle-color': '#007FA3',
					'circle-radius': 3,
					'circle-stroke-color': '#ffffff',
					'circle-stroke-width': 1,
				},
			});

			map.addLayer({
				id: 'pool-locs',
				type: 'circle',
				source: 'Pool',
				paint: {
					'circle-color': '#6FC7EA',
					'circle-radius': 3,
					'circle-stroke-color': '#ffffff',
					'circle-stroke-width': 1,
				},
			});

			map.addLayer({
				id: 'hospitals',
				type: 'circle',
				source: 'Hospitals',
				paint: {
					'circle-color': '#00A189',
					'circle-radius': 4.5,
					'circle-stroke-color': '#000000',
					'circle-stroke-width': 1.5,
				},
			});

			

			if (pageHeight > 700 && pageWidth > 800) {
				map.zoomTo(10.5)
			}

			updateLayerVisibility('hospitals', $showHospitals);
			updateLayerVisibility('cooling-cnts', $showCooling);
			updateLayerVisibility('pool-locs', $showPool);
			updateLayerVisibility('AptNoAir', $showAptNoAir);

			map.setLayoutProperty('Vulnerdata', 'visibility', 'visible');
		
		});
	});

</script>


<div class="legend">

	<h3>{indexs[index].name} Map</h3>

	<p>Index of </p>

	<div style = 'height: 20px'>
		<div class="legend-bar" style = 'background-image: linear-gradient(to right,{indexs[index].colours[0]},{indexs[index].colours[1]})'></div>
		<div class="legend-bar" style = 'background-image: linear-gradient(to right,{indexs[index].colours[1]},{indexs[index].colours[2]})'></div>
		<div class="legend-bar" style = 'background-image: linear-gradient(to right,{indexs[index].colours[2]},{indexs[index].colours[3]})'></div>
		<p>| Lo<span style = "letter-spacing: 177px">w</span>| High</p>
	</div>

</div>

<div id={index} class="map" style="height: {mapHeight}px; width:{mapWidth}px; margin-top: 50px;"></div>
	
<div class="buttons">
	
	<button on:click={togglePool} class:layerOn={$showPool} class:layerOff={!$showPool}>Outdoor Swimming & Wading Pools</button>
	<button on:click={toggleAptNoAir} class:layerOn={$showAptNoAir} class:layerOff={!$showAptNoAir}> Apartments Without Air Conditioning</button>
	<br>
	<button on:click={toggleHospitals} class:layerOn={$showHospitals} class:layerOff={!$showHospitals}> Hospitals</button>
	<button on:click={toggleCooling} class:layerOn={$showCooling} class:layerOff={!$showCooling}>Cooling Centres</button>

</div>



<style>

	.map {
		width: 100%;
		border-top: 1px solid var(--brandBlack);
		border-bottom: 1px solid var(--brandBlack);
	}

	.legend {
		max-width: 615px;
		height: 70px;
		margin: 0 auto;
		padding-left: 15px;
	}
	.legend-bar {
		width: 75px;
		height: 15px;
		display: inline-block;
		margin-left: -5px;
	}

	.buttons {
		max-width: 500px;
		width: 100%;
		margin: 0 auto;
		padding-top: 5px;
		padding-bottom: 5px;
	}
	@media screen and (max-width: 500px) {
		.buttons {
			max-width: 250px;
		}
	}

	button {
		font-family: RobotoBold;
		text-align: left;
		font-size: 14px;
		width: 245px;
		color: white;
		border: 1px solid var(--brandGray);
		padding: 5px;
		margin-bottom: 5px;
		cursor: pointer;
	}

	button:hover {
		opacity: 1;
		background-color: var(--brandLightBlue);
	}

	.layerOn {
		background-color: white;
		opacity: 1;
		color: var(--brandDarkBlue);
		border: 1px solid var(--brandDarkBlue);
	}

	.layerOff {
		background-color: white;
		color: var(--brandDarkBlue);
		opacity: 0.65;
	}

	p {
		margin-top: -8px;
		margin-bottom: -2px;
	}

</style>
<script>
	import { onMount } from 'svelte';
    import { showHospitals, showCooling, showPool, showAptNoAir } from '../routes/stores.js';
    import maplibregl from 'maplibre-gl';
    import * as pmtiles from 'pmtiles';
    import Wards from "../data/wards.geo.json";
    import Vulnerdata from "../data/data-reduced-final.geo.json";
    import Cooling from "../data/indoor-cooling-centres.geo.json";
    import Pool from "../data/swimming-wading-pools.geo.json";
    import AptNoAir from "../data/apt-no-aircon.geo.json";
    import Hospitals from "../data/hospitals.geo.json";
    import SubwayLines from "../data/subwayLines.geo.json";
    import SubwayStns from "../data/subwayStations.geo.json";
    import BaseLayer from "../data/toronto.json";


    let map;
    let PMTILES_URL = "/heat-vulnerability-toronto/toronto.pmtiles";

    export let index;

    let protocol = new pmtiles.Protocol();
    maplibregl.addProtocol('pmtiles', protocol.tile);

    let pageHeight;
    let pageWidth;

    let mapHeight = 665;
    $: if (pageHeight < 800) {
        mapHeight = pageHeight - 200;
    } else {
        mapHeight = 665
    }

    let mapWidth = pageWidth;


    const indexs = {
        "vulnerability": {
            "column": "pca_vuln_index",
            "breaks": [-7.16, -1.38, -0.37, 0.42, 1.38],
            // "colours": ["#2f57db", "#5947ac", "#883477", "#bb203e", "#BC312F"]
            // "colours": ["#527aaf","#666c97","#7d5c7b","#a9525a","#dc4633"]
            "colours": ["#527aaf","#666c97","#a9525a","#dc4633","#BC312F"]
        }, 
        "heatdegree": {
            "column": "degree20_sum_temp",
            "breaks": [2.3, 12.5, 13.9, 14.7, 15.4],
            "colours": ["#2f57db", "#5947ac", "#883477", "#bb203e", "#e41010"]
        },
        "adaptive": {
            "column": "pca_adaptive_index",
            "breaks": [0, 0.64, 0.7, 0.74, 0.78],
            "colours": ["#2f57db", "#5947ac", "#883477", "#bb203e", "#e41010"]
            // "colours": ["#d0d1c9", "#6fb4ea", "#dc5233", "#f1c500", "#8dbf2e"]
            //"colours": ["#d0d1c9", "#f1c500", "#cac312", "#8dbf2e", "#0d534d"]
        },
        "sensitivity": {
            "column": "pca_sensitivity_index",
            "breaks": [0, 0.46, 0.52, 0.56, 0.61],
            "colours": ["#2f57db", "#5947ac", "#883477", "#bb203e", "#e41010"]
        },
    };

    // Adding scale bar to the map
    let scale = new maplibregl.ScaleControl({
        maxWidth: 100,
        unit: 'metric',
    });


    // Function to toggle the visibility of Hospitals layer
    function toggleHospitals() {
        showHospitals.update((value) => !value);
        updateLayerVisibility('hospitals', $showHospitals);
    }

    // Function to toggle the visibility of Cooling Centres layer
    function toggleCooling() {
        showCooling.update((value) => !value);
        updateLayerVisibility('cooling-cnts', $showCooling);
    }

    // Function to toggle the visibility of Swimming/Wading Pools layer
    function togglePool() {
        showPool.update((value) => !value);
        updateLayerVisibility('pool-locs', $showPool);
    }

    // Function to toggle the visibility of Apartments without Air Condition layer
    function toggleAptNoAir() {
        showAptNoAir.update((value) => !value);
        updateLayerVisibility('AptNoAir', $showAptNoAir);
    }

    function updateLayerVisibility(layerID, visibility) {
        if (map) {
        map.setPaintProperty(layerID, 'circle-opacity', visibility ? 1 : 0);
        map.setPaintProperty(layerID, 'circle-stroke-opacity', visibility ? 1 : 0);
        }
    }

    $: updateLayerVisibility('hospitals', $showHospitals);
    $: updateLayerVisibility('cooling-cnts', $showCooling);
    $: updateLayerVisibility('pool-locs', $showPool);
    $: updateLayerVisibility('AptNoAir', $showAptNoAir);
  
    const maxBounds = [
		[-79.6772, 43.4400], // SW coords
		[-79.04763, 44.03074] // NE coords
	];

    onMount(() => {
        map = new maplibregl.Map({
			container: index, 
            style: {
                    "version": 8,
                    "name": "Empty",
                    "glyphs": "https://schoolofcities.github.io/fonts/fonts/{fontstack}/{range}.pbf",
                    "sources": {},
                    "layers": [
                        {
                        "id": "background",
                        "type": "background",
                        "paint": {
                            "background-color": "rgba(0,0,0,0)"
                        }
                        }
                    ]
                },
			center: [-79.37, 43.715],
			zoom: 9.5,
			maxZoom: 16.5,
			minZoom: 8.5,
			bearing: -17.1,
			projection: 'globe',
			scrollZoom: true,
            maxBounds: maxBounds,
			attributionControl: true
		});

        map.addControl(scale, 'bottom-left');
        // Adding zoom and rotation controls to the map
        map.addControl(new maplibregl.NavigationControl(), 'top-left');
        map.scrollZoom.disable();

        let protoLayers = BaseLayer;

        map.on('load', function() {
            const attributions = [
                'Â© <a href="https://openstreetmap.org">OpenStreetMap</a>',
                '<a href="https://github.com/Moraine729/Toronto_Heat_Vulnerability">Github</a>',
                '<a href="https://open.toronto.ca/">City of Toronto Open Data Portal</a>'
            ];

            // Convert the array into a single string
            const attributionString = attributions.join(' | ');

            // Add the source with the concatenated attribution string
            map.addSource('protomaps', {
                type: "vector",
                url: "pmtiles://" + PMTILES_URL,
                attribution: attributionString,
                attributionControl: false,
            });

            // Disable pitch control
            map.touchZoomRotate.disableRotation();
            
            protoLayers.forEach(e => {
            map.addLayer(e);
            });

            map.addSource('Wards', {
                'type': 'geojson',
                'data': Wards
            });

            map.addSource('Vulnerdata', {
                'type': 'geojson',
                'data': Vulnerdata
            });

            map.addSource('SubwayLines', {
                'type': 'geojson',
                'data': SubwayLines
            });
            map.addSource('SubwayStns', {
                'type': 'geojson',
                'data': SubwayStns
            });

            map.addSource('Hospitals', {
                'type': 'geojson',
                'data': Hospitals
            });

            map.addSource('Cooling', {
                'type': 'geojson',
                'data': Cooling
            });

            map.addSource('Pool', {
                'type': 'geojson',
                'data': Pool
            });

            map.addSource('AptNoAir', {
                'type': 'geojson',
                'data': AptNoAir
            });

            map.addLayer({
            id: 'subway-lines',
            type: 'line',
            source: 'SubwayLines',
            paint: {
                'line-color': '#a74e74ff',
                'line-width': 2.5,
                },
            });

            map.addLayer({
                id: 'subway-stations',
                type: 'circle',
                source: 'SubwayStns',
                paint: {
                    'circle-color': '#AB1368',
                    'circle-radius': 3,
                    // 'circle-stroke-color': '#ffffff',
                    // 'circle-stroke-width': 1.2,
                },
            });

            map.addLayer({
                'id': 'WardsWhite',
                'type': 'line',
                'source': 'Wards',
                'layout': {},
                'paint': {
                    'line-color': '#fff',
                    'line-width': 4,
                    'line-opacity': 1
                }
            }, 'subway-lines');

            map.addLayer({
                'id': 'WardsBlack',
                'type': 'line',
                'source': 'Wards',
                'layout': {},
                'paint': {
                    'line-color': '#000',
                    'line-width': 2,
                    'line-opacity': 1
                }
            }, 'subway-lines');

            map.addLayer({
                'id': 'Vulnerdata',
                'type': 'fill',
                'source': 'Vulnerdata',
                'layout': {},
                'paint': {
                    'fill-color': [
                            'step',
                            ['get', indexs[index].column],
                            indexs[index].colours[0],
                            indexs[index].breaks[0],
                            indexs[index].colours[1],
                            indexs[index].breaks[1],
                            indexs[index].colours[2],
                            indexs[index].breaks[2],
                            indexs[index].colours[3],
                            indexs[index].breaks[3],
                            indexs[index].colours[4]
                    ],
                    'fill-opacity': 0.5,
                    }
                });

            map.addLayer({
                id: 'AptNoAir',
                type: 'circle',
                source: 'AptNoAir',
                paint: {
                    'circle-color': '#DC4633',
                    'circle-radius': 2.7,
                    'circle-stroke-color': '#6D247A',
                    'circle-stroke-width': 1,
                },
            });

            map.addLayer({
                id: 'cooling-cnts',
                type: 'circle',
                source: 'Cooling',
                paint: {
                    'circle-color': '#007FA3',
                    'circle-radius': 3,
                    'circle-stroke-color': '#ffffff',
                    'circle-stroke-width': 1,
                },
            });

            map.addLayer({
                id: 'pool-locs',
                type: 'circle',
                source: 'Pool',
                paint: {
                    'circle-color': '#6FC7EA',
                    'circle-radius': 3,
                    'circle-stroke-color': '#ffffff',
                    'circle-stroke-width': 1,
                },
            });

            map.addLayer({
                id: 'hospitals',
                type: 'circle',
                source: 'Hospitals',
                paint: {
                    'circle-color': '#F1C500',
                    'circle-radius': 3.5,
                    'circle-stroke-color': '#000000',
                    'circle-stroke-width': 1.5,
                },
            });

            if (pageHeight > 700 && pageWidth > 800) {
                map.zoomTo(10.5)
            }
        map.setLayoutProperty('Vulnerdata', 'visibility', 'visible');
        
        });
    });

</script>

<div id={index} class="map" style="height: {mapHeight}px; width:{mapWidth}px; margin-top: 50px;"></div>
    <div>
        <button on:click={toggleHospitals} class:layerOn={$showHospitals} class:layerOff={!$showHospitals}> Hospitals</button>
        <button on:click={toggleCooling} class:layerOn={$showCooling} class:layerOff={!$showCooling}> Cooling Centres</button>
        <button on:click={togglePool} class:layerOn={$showPool} class:layerOff={!$showPool}> Swimming/Wading Pools</button>
        <button on:click={toggleAptNoAir} class:layerOn={$showAptNoAir} class:layerOff={!$showAptNoAir}> Apartments without AC</button>
    </div>


 <style>
    .map {
        width: 100%;
        border-top: 2px solid var(--brandPink50);
        border-bottom: 2px solid var(--brandPink50);
        /* border-left: 2px solid var(--brandPink50);
        border-right: 2px solid var(--brandPink50); */
    }

    button {
        font-family: Roboto;
        font-size: 14px;
        color: white;
        background-color: var(--brandPink);
        border: 1px solid var(--brandPink);
        padding: 5px 5px;
        cursor: pointer;
    }

    button:hover {
		opacity: 1;
		background-color: transparent;
        color: var(--brandPink);
        border: 1px solid var(--brandPink);
	}

    .layerOn {
		opacity: 1;
	}

	.layerOff {
        background-color: transparent;
        color: var(--brandPink80);
		opacity: 0.42;
	}

</style>
<script>
	import { onMount } from 'svelte';
	import maplibregl from 'maplibre-gl';
	import * as pmtiles from 'pmtiles';
	import layers from 'protomaps-themes-base';
    import Wards from "../data/wards.geo.json";
    import WardPts from '../data/wardsPts.geo.json';
    import Vulnerdata from "../data/data-reduced-final.geo.json";
    import Cooling from "../data/indoor-cooling-centres.geo.json";
    import Pool from "../data/swimming-wading-pools.geo.json";
    import AptAir from "../data/apt-central-air.geo.json";
    import AptNoAir from "../data/apt-no-aircon.geo.json";
    import Hospitals from "../data/hospitals.geo.json";
    import SubwayLines from "../data/subwayLines.geo.json";
    import SubwayStns from "../data/subwayStations.geo.json";
    import BaseLayer from "../data/toronto.json";
    import '../routes/styles.css';

    let map;
	let PMTILES_URL = "/heat-vulnerability-toronto/toronto.pmtiles";

    export let index;

	let protocol = new pmtiles.Protocol();
	maplibregl.addProtocol('pmtiles', protocol.tile);
    
    let pageHeight;
    let pageWidth;

    let mapHeight = 665;
    $: if (pageHeight < 800) {
        mapHeight = pageHeight - 200;
    } else {
        mapHeight = 665
    }

    let mapWidth = pageWidth;

    const indexs = {
        "vulnerability": {
            "column": "pca_vuln_index",
            "breaks": [-7.16, -1.38, -0.37, 0.42, 1.38],
            "colours": ["#2f57db", "#5947ac", "#883477", "#bb203e", "#e41010"]
        }, 
        "heatdegree": {
            "column": "degree20_sum_temp",
            "breaks": [2.3, 12.5, 13.9, 14.7, 15.4],
            "colours": ["#2f57db", "#5947ac", "#883477", "#bb203e", "#e41010"]
        },
        "adaptive": {
            "column": "pca_adaptive_index",
            "breaks": [0, 0.64, 0.7, 0.74, 0.78],
            "colours": ["#2f57db", "#5947ac", "#883477", "#bb203e", "#e41010"]
        },
        "sensitivity": {
            "column": "pca_sensitivity_index",
            "breaks": [0, 0.46, 0.52, 0.56, 0.61],
            "colours": ["#2f57db", "#5947ac", "#883477", "#bb203e", "#e41010"]
        },
    };


    // Adding scale bar to the map
    let scale = new maplibregl.ScaleControl({
      maxWidth: 100,
      unit: 'metric',
    });

    let selectedButton = [];
    // Set initial visibility settings for layers
    let showHospitals = true;
    let showCooling = true;
    let showPool = true;
    let showAptNoAir = true;
    let showSubwayLines = true;
    let showSubwayStations = true;

    const layerOpacity = 0.69;

    const maxBounds = [
		[-79.6772, 43.4400], // SW coords
		[-79.04763, 44.03074] // NE coords
	];
    
    // Function to toggle Hospitals layer visibility
    function toggleHospitals() {
        showHospitals = !showHospitals;
        const visibility = showHospitals ? 'visible' : 'none';
        map.setLayoutProperty('hospitals', 'visibility', visibility);
    }

    // Function to toggle Cooling Centres layer visibility
    function toggleCooling() {
        showCooling = !showCooling;
        const visibility = showCooling ? 'visible' : 'none';
        map.setLayoutProperty('cooling-cnts', 'visibility', visibility);
    }

    // Function to toggle Swimming/Wading Pools layer visibility
    function togglePool() {
        showPool = !showPool;
        const visibility = showPool ? 'visible' : 'none';
        map.setLayoutProperty('Pool-locs', 'visibility', visibility);
    }

    // Function to toggle Apartments without Air Condition layer visibility
    function toggleAptNoAir() {
        showAptNoAir = !showAptNoAir;
        const visibility = showAptNoAir ? 'visible' : 'none';
        map.setLayoutProperty('AptNoAir', 'visibility', visibility);
    }

    // Function to toggle SubwayLines and SubwayStations layer visibility
    function toggleSubway() {
    showSubwayLines = !showSubwayLines;
    showSubwayStations = !showSubwayStations;

    const linesVisibility = showSubwayLines ? 'visible' : 'none';
    const stationsVisibility = showSubwayStations ? 'visible' : 'none';

    map.setLayoutProperty('subway-lines', 'visibility', linesVisibility);
    map.setLayoutProperty('subway-stations', 'visibility', stationsVisibility);
    }

    // Function to change button style when the layer is selected
    function toggleButton(button) {
        const mapLayer = document.getElementById(index);

        const buttonElement = document.querySelector(`button[data-layer="${button}"]`);

        if (selectedButton.includes(button)) {
        // Remove button from selectedButton array
        selectedButton = selectedButton.filter(item => item !== button);

        // Implement your logic to hide the layer
        hideLayer(button);

        // Remove 'selected' class from the button
        if (buttonElement) {
            buttonElement.classList.remove('selected');
        }
        } else {
            // Add button to selectedButton array
            selectedButton.push(button);

            // Implement your logic to show the layer
            showLayer(button);

            // Add 'selected' class to the button
            if (buttonElement) {
                buttonElement.classList.add('selected');
            }
        }
    }

    function hideLayer(layer) {
        switch (layer) {
            case 'hospitals':
                toggleHospitals();
                break;
            case 'cooling':
                toggleCooling();
                break;
            case 'pool':
                togglePool();
                break;
            case 'aptNoAir':
                toggleAptNoAir();
                break;
            case 'subway':
                toggleSubway();
                break;
            default:
                break;
        }
    }

    function showLayer(layer) {
        // You can implement additional logic here if needed
        // (e.g., setting initial visibility, adjusting styles, etc.)
        hideLayer(layer);
    }

    onMount(() => {
        map = new maplibregl.Map({
			container: index, 
            style: {
                    "version": 8,
                    "name": "Empty",
                    "glyphs": "https://protomaps.github.io/basemaps-assets/fonts/{fontstack}/{range}.pbf", //"https://schoolofcities.github.io/fonts/fonts/{fontstack}/{range}.pbf",
                    "sources": {},
                    "layers": [
                        {
                        "id": "background",
                        "type": "background",
                        "paint": {
                            "background-color": "rgba(0,0,0,0)"
                        }
                        }
                    ]
                },
			center: [-79.37, 43.715],
			zoom: 9.5,
			maxZoom: 16.5,
			minZoom: 8.5,
			bearing: -17.1,
			projection: 'globe',
			scrollZoom: true,
            maxBounds: maxBounds,
			attributionControl: true
		});

        map.addControl(scale, 'bottom-left');
        // Adding zoom and rotation controls to the map
        map.addControl(new maplibregl.NavigationControl(), 'top-left');
        map.scrollZoom.disable();

        let protoLayers = BaseLayer;//layers("protomaps","white");

        map.on('load', function() {
            map.addSource('protomaps', {
			type: "vector",
			url: "pmtiles://" + PMTILES_URL,
			attribution: 'Â© <a href="https://openstreetmap.org">OpenStreetMap</a>'
            });

            protoLayers.forEach(e => {
            map.addLayer(e);
            });

            map.addSource('Wards', {
                'type': 'geojson',
                'data': Wards
            });
            map.addSource('WardPts', {
                'type': 'geojson',
                'data': WardPts
            });

            map.addSource('Vulnerdata', {
                'type': 'geojson',
                'data': Vulnerdata
            });

            map.addSource('SubwayLines', {
                'type': 'geojson',
                'data': SubwayLines
            });
            map.addSource('SubwayStns', {
                'type': 'geojson',
                'data': SubwayStns
            });

            map.addSource('Hospitals', {
                'type': 'geojson',
                'data': Hospitals
            });

            map.addSource('Cooling', {
                'type': 'geojson',
                'data': Cooling
            });

            map.addSource('Pool', {
                'type': 'geojson',
                'data': Pool
            });

            map.addSource('AptNoAir', {
                'type': 'geojson',
                'data': AptNoAir
            });

            map.addLayer({
            id: 'subway-lines',
            type: 'line',
            source: 'SubwayLines',
            paint: {
                'line-color': '#a74e74ff',
                'line-width': 2.5,
                },
            });

            map.addLayer({
                id: 'subway-stations',
                type: 'circle',
                source: 'SubwayStns',
                paint: {
                    'circle-color': '#AB1368',
                    'circle-radius': 3,
                    // 'circle-stroke-color': '#ffffff',
                    // 'circle-stroke-width': 1.2,
                },
            });

            map.addLayer({
                'id': 'WardsWhite',
                'type': 'line',
                'source': 'Wards',
                'layout': {},
                'paint': {
                    'line-color': '#fff',
                    'line-width': 4,
                    'line-opacity': 1
                }
            }, 'subway-lines');

            map.addLayer({
                'id': 'WardsBlack',
                'type': 'line',
                'source': 'Wards',
                'layout': {},
                'paint': {
                    'line-color': '#000',
                    'line-width': 2,
                    'line-opacity': 1
                }
            }, 'subway-lines');

            map.addLayer({
                'id': 'WardsLabel',
                'type': 'symbol',
                'source': 'WardPts',
                'layout': {
                    'text-field': ['get', 'name'],
                    'text-font': ['Roboto'],
                    'text-size': 12,
                    'text-transform': "uppercase",
                    'text-justify': 'center',
                    'text-allow-overlap': true,
                },
                'paint': {
                    'text-halo-width': 1, 
                    'text-halo-color': '#fff',
                    'text-opacity': [
                        "interpolate",
                        ["linear"],
                        ["zoom"],
                        10.1,
                        0,
                        10.2,
                        1
                    ]
                },
                'glyphs':'https://schoolofcities.github.io/fonts/fonts/{fontstack}/{range}.pbf',
            });

            map.addLayer({
                'id': 'Vulnerdata',
                'type': 'fill',
                'source': 'Vulnerdata',
                'layout': {},
                'paint': {
                    'fill-color': [
                        //'case',
                        //['get', 'pca_adaptive_index'],
                        //[
                            'step',
                            ['get', indexs[index].column],
                            indexs[index].colours[0],
                            indexs[index].breaks[0],
                            indexs[index].colours[1],
                            indexs[index].breaks[1],
                            indexs[index].colours[2],
                            indexs[index].breaks[2],
                            indexs[index].colours[3],
                            indexs[index].breaks[3],
                            indexs[index].colours[4]
                    //        ],
                    //    "#fff"
                    ],
                    'fill-opacity': 0.5,
                    }
                });

            map.addLayer({
                id: 'AptNoAir',
                type: 'circle',
                source: 'AptNoAir',
                paint: {
                    'circle-color': '#6D247A',
                    'circle-radius': 2.7,
                    'circle-stroke-color': '#DC4633',
                    'circle-stroke-width': 1,
                },
            });

            map.addLayer({
                id: 'cooling-cnts',
                type: 'circle',
                source: 'Cooling',
                paint: {
                    'circle-color': '#007FA3',
                    'circle-radius': 3,
                    'circle-stroke-color': '#ffffff',
                    'circle-stroke-width': 1,
                },
            });

            map.addLayer({
                id: 'Pool-locs',
                type: 'circle',
                source: 'Pool',
                paint: {
                    'circle-color': '#6FC7EA',
                    'circle-radius': 3,
                    'circle-stroke-color': '#ffffff',
                    'circle-stroke-width': 1,
                },
            });

            map.addLayer({
                id: 'hospitals',
                type: 'circle',
                source: 'Hospitals',
                paint: {
                    'circle-color': '#F1C500',
                    'circle-radius': 3.5,
                    'circle-stroke-color': '#000000',
                    'circle-stroke-width': 1.5,
                },
            });

            if (pageHeight > 700 && pageWidth > 800) {
                map.zoomTo(10.5)
            }
        map.setLayoutProperty('Vulnerdata', 'visibility', 'visible');
        
        });
    });

</script>

<div id={index} class="map" style="height: {mapHeight}px; width:{mapWidth}px; margin-top: 50px;"></div>
    <div>
        <button on:click={() => toggleButton('hospitals')} class={selectedButton === 'hospitals' ? 'selected' : ''}> Hospitals</button>
        <button on:click={() => toggleButton('cooling')} class={selectedButton === 'cooling' ? 'selected' : ''}> Cooling Centres</button>
        <button on:click={() => toggleButton('pool')} class={selectedButton === 'pool' ? 'selected' : ''}> Swimming/Wading Pools</button>
        <button on:click={() => toggleButton('aptNoAir')} class={selectedButton === 'aptNoAir' ? 'selected' : ''}> Apartments without AC</button>
        <button on:click={() => toggleButton('subway')} class={selectedButton === 'subway' ? 'selected' : ''}> TTC Subway</button>
        <dsources>Data Sources: City of Toronto Open Data Portal, OpenStreetMap</dsources>
    </div>


 <style>
    .map {
        width: 100%;
        border-top: 2px solid var(--brandPink50);
        border-bottom: 2px solid var(--brandPink50);
        border-left: 2px solid var(--brandPink50);
        border-right: 2px solid var(--brandPink50);
    }

	dsources {
		margin: 0 auto;
		text-align: right;
		font-size: 11px;
		max-width: 1000px;
		color: var(--brandPink);
	}

    button {
        font-family: Roboto;
        font-size: 14px;
        color: white;
        background-color: var(--brandPink);
        border: 1px solid var(--brandPink);
        padding: 5px 5px;
        cursor: pointer;
    }
    
    button.selected {
        background-color: transparent;
        color: var(--brandPink80);
        border: 1px solid transparent;
    }
</style>
<script>
	import { onMount } from 'svelte';
	import maplibregl from 'maplibre-gl';
	import * as pmtiles from 'pmtiles';
	import layers from 'protomaps-themes-base';
    import Wards from "../data/wards.geo.json";
    import WardPts from "../data/wardsPts.geo.json";
    import Hdata from "../data/data-all-final-reduced-v3.geo.json";
    import Hospitals from "../data/hospitals.geo.json";
    import SubwayLines from "../data/subwayLines.geo.json";
    import SubwayStns from "../data/subwayStations.geo.json";
    import '../routes/styles.css';

    let map;
	let PMTILES_URL = "/heat-vulnerability-toronto/toronto.pmtiles";

	let protocol = new pmtiles.Protocol();
	maplibregl.addProtocol('pmtiles', protocol.tile);
    
    let pageHeight;
    let pageWidth;

    let mapHeight = 600;
    $: if (pageHeight < 800) {
        mapHeight = pageHeight - 200;
    } else {
        mapHeight = 600
    }

    let mapWidth = pageWidth;

    // Adding scale bar to the map
    let scale = new maplibregl.ScaleControl({
      maxWidth: 100,
      unit: 'metric',
    });

    let showHospitals = true;
    let showSubwayLines = true;
    let showSubwayStations = true;
    let selectedField = 'pca_vuln_index';

    const layerOpacity = 0.69;

    const maxBounds = [
		[-79.6772, 43.4400], // SW coords
		[-79.04763, 44.03074] // NE coords
	];
    
    // Function to toggle Hospitals layer visibility
    function toggleHospitals() {
        showHospitals = !showHospitals;
        const visibility = showHospitals ? 'visible' : 'none';
        map.setLayoutProperty('hospitals', 'visibility', visibility);
    }

    // Function to toggle SubwayLines layer visibility
    function toggleSubwayLines() {
        showSubwayLines = !showSubwayLines;
        const visibility = showSubwayLines ? 'visible' : 'none';
        map.setLayoutProperty('subway-lines', 'visibility', visibility);
    }

    // Function to toggle SubwayStations layer visibility
    function toggleSubwayStations() {
        showSubwayStations = !showSubwayStations;
        const visibility = showSubwayStations ? 'visible' : 'none';
        map.setLayoutProperty('subway-stations', 'visibility', visibility);
    }

    // Function to update the color scale based on the selected field
    function updateColorScale(field) {
        selectedField = field;
        const colorStops = getColorStops(field);
        map.setPaintProperty('Hdata', 'fill-color', [
            'interpolate',
            ['linear'],
            ['get', field],
            ...colorStops
        ]);
    }

    // Function to get color stops based on the selected field
    function getColorStops(field) {
        switch (field) {
            case 'cool_access':
                return [31, '#2f57db', 247, '#5947ac', 368, '#883477', 516, '#bb203e', 728, '#e41010'];
            case 'hospital_access':
                return [30, '#2f57db', 135, '#5947ac', 202, '#883477', 284, '#bb203e', 413, '#e41010'];
                break;
            case 'pca_adaptive_index_final':
                return [0, '#2f57db', 0.64, '#5947ac', 0.7, '#883477', 0.74, '#bb203e', 0.78, '#e41010'];
                break;
            case 'degree20_sum_temp':
                return [2.3, '#2f57db', 12.5, '#5947ac', 13.9, '#883477', 14.7, '#bb203e', 15.4, '#e41010'];
                break;
            case 'pca_vuln_index':
            default:
                return [-7.16, '#2f57db', -1.38, '#5947ac', -0.37, '#883477', 0.42, '#bb203e', 1.38, '#e41010'];
        }
    }

    onMount(() => {
        map = new maplibregl.Map({
			container: 'map', 
			style: './vector-tiles-vintage-v5.json',
			center: [-79.37, 43.715],
			zoom: 9.5,
			maxZoom: 16.5,
			minZoom: 8.5,
			bearing: -17.1,
			projection: 'globe',
			scrollZoom: true,
            maxBounds: maxBounds,
			attributionControl: true
		});
        map.addControl(scale, 'bottom-left');
        // Adding zoom and rotation controls to the map
        map.addControl(new maplibregl.NavigationControl(), 'top-left');
        map.scrollZoom.disable();

        map.on('load', function() {
            map.addSource('Wards', {
                'type': 'geojson',
                'data': Wards
            });
        
            map.addSource('tdata', {
                'type': 'geojson',
                'data': Hdata
            });

            map.addLayer({
            'id': 'tdata',
            'type': 'fill',
            'source': 'Hdata',
            'layout': {},
            'paint': {
                'fill-color': [
                    ['round', ['get', 'pca_vuln_index']],  // Round the value to an integer
                    -7, '#2f57db',
                    -1, '#5947ac',
                    0, '#883477',
                    1, '#bb203e',
                    2, '#e41010',
                    /* default color if none of the values match */
                    '#000'
                ],
                'fill-opacity': 1
                }
            });

            

            if (pageHeight > 700 && pageWidth > 800) {
                map.zoomTo(10.5)
            }
        map.setLayoutProperty('tdata', 'visibility', 'visible');

        });
    });
</script>

<div id="map" style="height: {mapHeight}px; width:{mapWidth}px; margin-top: 50px;"></div>
    <div>
        <button on:click={toggleHospitals}> Hospitals</button>
        <button on:click={toggleSubwayLines}> Subway Lines</button>
        <button on:click={toggleSubwayStations}> Subway Stations</button>
        <select bind:value={selectedField} on:change={() => updateColorScale(selectedField)}>
            <option value="pca_adaptive_index_final">Adaptive Index</option>
            <option value="degree20_sum_temp">Degree 20 Sum Temp</option>
            <option value="pca_vuln_index">Vulnerability Index</option>
        </select>
    </div>
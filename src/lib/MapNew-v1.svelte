<script>
	import { onMount } from 'svelte';
	import maplibregl from 'maplibre-gl';
	import * as pmtiles from 'pmtiles';
	import layers from 'protomaps-themes-base';
    import Wards from "../data/wards.geo.json";
    import WardPts from '../data/wardsPts.geo.json';
    import Vdata from "../data/data-reduced-final.geo.json";
    import Cooling from "../data/indoor-cooling-centres.geo.json";
    import Pool from "../data/swimming-wading-pools.geo.json";
    import AptAir from "../data/apt-central-air.geo.json";
    import AptNoAir from "../data/apt-no-aircon.geo.json";
    import Hospitals from "../data/hospitals.geo.json";
    import SubwayLines from "../data/subwayLines.geo.json";
    import SubwayStns from "../data/subwayStations.geo.json";
    import '../routes/styles.css';

    let map;
	let PMTILES_URL = "/heat-vulnerability-toronto/toronto.pmtiles";

	let protocol = new pmtiles.Protocol();
	maplibregl.addProtocol('pmtiles', protocol.tile);
    
    let pageHeight;
    let pageWidth;

    let mapHeight = 665;
    $: if (pageHeight < 800) {
        mapHeight = pageHeight - 200;
    } else {
        mapHeight = 665
    }

    let mapWidth = pageWidth;

    // Adding scale bar to the map
    let scale = new maplibregl.ScaleControl({
      maxWidth: 100,
      unit: 'metric',
    });

    let showHospitals = true;
    let showCooling = true;
    let showPool = true;
    let showAptNoAir = true;
    let showSubwayLines = true;
    let showSubwayStations = true;
    let selectedField = 'pca_vuln_index';

    const layerOpacity = 0.69;

    const maxBounds = [
		[-79.6772, 43.4400], // SW coords
		[-79.04763, 44.03074] // NE coords
	];
    
    // Function to toggle Hospitals layer visibility
    function toggleHospitals() {
        showHospitals = !showHospitals;
        const visibility = showHospitals ? 'visible' : 'none';
        map.setLayoutProperty('hospitals', 'visibility', visibility);
    }

    // Function to toggle Cooling Centres layer visibility
    function toggleCooling() {
        showCooling = !showCooling;
        const visibility = showCooling ? 'visible' : 'none';
        map.setLayoutProperty('cooling-cnts', 'visibility', visibility);
    }

    // Function to toggle Swimming/Wading Pools layer visibility
    function togglePool() {
        showPool = !showPool;
        const visibility = showPool ? 'visible' : 'none';
        map.setLayoutProperty('Pool-locs', 'visibility', visibility);
    }

    // Function to toggle Apartments without Air Condition layer visibility
    function toggleAptNoAir() {
        showAptNoAir = !showAptNoAir;
        const visibility = showAptNoAir ? 'visible' : 'none';
        map.setLayoutProperty('AptNoAir', 'visibility', visibility);
    }

    // Function to toggle SubwayLines and SubwayStations layer visibility
    function toggleSubway() {
    showSubwayLines = !showSubwayLines;
    showSubwayStations = !showSubwayStations;

    const linesVisibility = showSubwayLines ? 'visible' : 'none';
    const stationsVisibility = showSubwayStations ? 'visible' : 'none';

    map.setLayoutProperty('subway-lines', 'visibility', linesVisibility);
    map.setLayoutProperty('subway-stations', 'visibility', stationsVisibility);
    }

    // Function to update the color scale based on the selected field
    function updateColorScale(field) {
        selectedField = field;
        const colorStops = getColorStops(field);
        map.setPaintProperty('Vdata', 'fill-color', [
            'interpolate',
            ['linear'],
            ['get', field],
            ...colorStops
        ]);
    }

    // Function to get color stops based on the selected field
    function getColorStops(field) {
        switch (field) {
            case 'cool_access':
                return [31, '#2f57db', 247, '#5947ac', 368, '#883477', 516, '#bb203e', 728, '#e41010'];
            case 'hospital_access':
                return [30, '#2f57db', 135, '#5947ac', 202, '#883477', 284, '#bb203e', 413, '#e41010'];
                break;
            case 'pca_sensitivity_index':
                return [0, '#2f57db', 0.46, '#5947ac', 0.52, '#883477', 0.56, '#bb203e', 0.61, '#e41010'];
                break;
            case 'pca_adaptive_index':
                return [0, '#2f57db', 0.64, '#5947ac', 0.7, '#883477', 0.74, '#bb203e', 0.78, '#e41010'];
                break;
            case 'degree20_sum_temp':
                return [2.3, '#2f57db', 12.5, '#5947ac', 13.9, '#883477', 14.7, '#bb203e', 15.4, '#e41010'];
                break;
            case 'pca_vuln_index':
            default:
                return [-7.16, '#2f57db', -1.38, '#5947ac', -0.37, '#883477', 0.42, '#bb203e', 1.38, '#e41010'];
        }
    }

    onMount(() => {
        map = new maplibregl.Map({
			container: 'map', 
            style: {
                    "version": 8,
                    "name": "Empty",
                    "glyphs": "https://protomaps.github.io/basemaps-assets/fonts/{fontstack}/{range}.pbf", //"https://schoolofcities.github.io/fonts/fonts/{fontstack}/{range}.pbf",
                    "sources": {},
                    "layers": [
                        {
                        "id": "background",
                        "type": "background",
                        "paint": {
                            "background-color": "rgba(0,0,0,0)"
                        }
                        }
                    ]
                },
			center: [-79.37, 43.715],
			zoom: 9.5,
			maxZoom: 16.5,
			minZoom: 8.5,
			bearing: -17.1,
			projection: 'globe',
			scrollZoom: true,
            maxBounds: maxBounds,
			attributionControl: true
		});
        map.addControl(scale, 'bottom-left');
        // Adding zoom and rotation controls to the map
        map.addControl(new maplibregl.NavigationControl(), 'top-left');
        map.scrollZoom.disable();

        

        let protoLayers = layers("protomaps","white"); //change this to json file
        
        console.log(protoLayers)
        map.on('load', function() {
            map.addSource('protomaps', {
			type: "vector",
			url: "pmtiles://" + PMTILES_URL,
			attribution: 'Â© <a href="https://openstreetmap.org">OpenStreetMap</a>'
            });

            protoLayers.forEach(e => {
            map.addLayer(e);
            });

            map.addSource('Wards', {
                'type': 'geojson',
                'data': Wards
            });
            map.addSource('WardPts', {
                'type': 'geojson',
                'data': WardPts
            });

            map.addSource('Vdata', {
                'type': 'geojson',
                'data': Vdata
            });

            map.addSource('SubwayLines', {
                'type': 'geojson',
                'data': SubwayLines
            });
            map.addSource('SubwayStns', {
                'type': 'geojson',
                'data': SubwayStns
            });

            map.addSource('Hospitals', {
                'type': 'geojson',
                'data': Hospitals
            });

            map.addSource('Cooling', {
                'type': 'geojson',
                'data': Cooling
            });

            map.addSource('Pool', {
                'type': 'geojson',
                'data': Pool
            });

            map.addSource('AptNoAir', {
                'type': 'geojson',
                'data': AptNoAir
            });

            map.addLayer({
            id: 'subway-lines',
            type: 'line',
            source: 'SubwayLines',
            paint: {
                'line-color': '#A4303F',
                'line-width': 3,
                },
            });

            map.addLayer({
                id: 'subway-stations',
                type: 'circle',
                source: 'SubwayStns',
                paint: {
                    'circle-color': '#cca89d',
                    'circle-radius': 3.2,
                    'circle-stroke-color': '#ffffff',
                    'circle-stroke-width': 1.2,
                },
            });

            map.addLayer({
                'id': 'WardsWhite',
                'type': 'line',
                'source': 'Wards',
                'layout': {},
                'paint': {
                    'line-color': '#fff',
                    'line-width': 4,
                    'line-opacity': 1
                }
            }, 'subway-lines');

            map.addLayer({
                'id': 'WardsBlack',
                'type': 'line',
                'source': 'Wards',
                'layout': {},
                'paint': {
                    'line-color': '#000',
                    'line-width': 2,
                    'line-opacity': 1
                }
            }, 'subway-lines');

            map.addLayer({
                'id': 'WardsLabel',
                'type': 'symbol',
                'source': 'WardPts',
                'layout': {
                    'text-field': ['get', 'name'],
                    'text-font': ['Roboto'],
                    'text-size': 12,
                    'text-transform': "uppercase",
                    'text-justify': 'center',
                    'text-allow-overlap': true,
                },
                'paint': {
                    'text-halo-width': 1, 
                    'text-halo-color': '#fff',
                    'text-opacity': [
                        "interpolate",
                        ["linear"],
                        ["zoom"],
                        10.1,
                        0,
                        10.2,
                        1
                    ]
                },
                'glyphs':'https://schoolofcities.github.io/fonts/fonts/{fontstack}/{range}.pbf',
            });

            map.addLayer({
                'id': 'Vdata',
                'type': 'fill',
                'source': 'Vdata',
                'layout': {},
                'paint': {
                'fill-color': [
                    'interpolate',
                    ['linear'],
                    ['get', 'pca_vuln_index'],
                    -7.16, '#2f57db', 
                    -1.38, '#5947ac',
                    -0.37, '#883477',
                    0.42, '#bb203e',
                    1.38, '#e41010'
                    ],
                'fill-opacity': 0.42
            }
            });

            map.addLayer({
                id: 'AptNoAir',
                type: 'circle',
                source: 'AptNoAir',
                paint: {
                    'circle-color': '#db2f40',
                    'circle-radius': 2.7,
                    'circle-stroke-color': '#ffffff',
                    'circle-stroke-width': 1,
                },
            });

            map.addLayer({
                id: 'cooling-cnts',
                type: 'circle',
                source: 'Cooling',
                paint: {
                    'circle-color': '#2faddb',
                    'circle-radius': 3,
                    'circle-stroke-color': '#ffffff',
                    'circle-stroke-width': 1,
                },
            });

            map.addLayer({
                id: 'Pool-locs',
                type: 'circle',
                source: 'Pool',
                paint: {
                    'circle-color': '#1b7cde',
                    'circle-radius': 3,
                    'circle-stroke-color': '#ffffff',
                    'circle-stroke-width': 1,
                },
            });

            map.addLayer({
                id: 'hospitals',
                type: 'circle',
                source: 'Hospitals',
                paint: {
                    'circle-color': '#F1C500',
                    'circle-radius': 3.5,
                    'circle-stroke-color': '#000000',
                    'circle-stroke-width': 1.5,
                },
            });

            if (pageHeight > 700 && pageWidth > 800) {
                map.zoomTo(10.5)
            }
        map.setLayoutProperty('Vdata', 'visibility', 'visible');

        });
    });
</script>

<div id="map" style="height: {mapHeight}px; width:{mapWidth}px; margin-top: 50px;"></div>
    <div>
        <button on:click={toggleHospitals}> Hospitals</button>
        <button on:click={toggleCooling}> Cooling Centres</button>
        <button on:click={togglePool}> Outdoor Swimming/Wading Pools</button>
        <button on:click={toggleAptNoAir}> Apartments without AC</button>
        <button on:click={toggleSubway}> TTC Subway</button>
        <select bind:value={selectedField} on:change={() => updateColorScale(selectedField)}>
            <option value="pca_vuln_index">Vulnerability Index</option>
            <option value="pca_adaptive_index">Adaptive Index</option>
            <option value="degree20_sum_temp">Degree 20 Sum Temp</option>
            <option value="pca_sensitivity_index">Sensitivity Index</option>
        </select>
    </div>